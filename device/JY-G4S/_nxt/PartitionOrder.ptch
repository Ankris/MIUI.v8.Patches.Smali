appfile <Settings.apk>;

# Partition order in memory settiings
replaceinfile "%smali%/com/android/settings/deviceinfo/MiuiMemory.smali" "instance fields" "instance fields \n    .field private mPartitionOrder:Landroid/preference/ListPreference;";
replaceinfile "%smali%/com/android/settings/deviceinfo/MiuiMemory.smali" "invoke-super {p0, p1}, Lcom/android/settings/deviceinfo/Memory;->onCreate(Landroid/os/Bundle;)V" "invoke-super {p0, p1}, Lcom/android/settings/deviceinfo/Memory;->onCreate(Landroid/os/Bundle;)V\n\n    const-string v0, "select_primary_storage"\n\n    invoke-virtual {p0, v0}, Lcom/android/settings/deviceinfo/MiuiMemory;->findPreference(Ljava/lang/CharSequence;)Landroid/preference/Preference;\n\n    move-result-object v0\n\n    check-cast v0, Landroid/preference/ListPreference;\n\n    iput-object v0, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mPartitionOrder:Landroid/preference/ListPreference;\n\n    iget-object v0, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mPartitionOrder:Landroid/preference/ListPreference;\n\n    invoke-virtual {v0, p0}, Landroid/preference/ListPreference;->setOnPreferenceChangeListener(Landroid/preference/Preference$OnPreferenceChangeListener;)V";
replaceinmethod "%smali%/com/android/settings/deviceinfo/MiuiMemory.smali" ".method public onPreferenceChange(Landroid/preference/Preference;Ljava/lang/Object;)Z" ".prologue" ".prologue\n    const-string v0, "select_primary_storage"\n    invoke-virtual {p1}, Landroid/preference/Preference;->getKey()Ljava/lang/String;\n    move-result-object v1\n    invoke-virtual {v0, v1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z\n    move-result v0\n    if-eqz v0, :end_storage\n\n    const-string v2, "am start -a android.intent.action.MAIN -e message 'Reboot to apply changes' -n com.rja.utility/.ShowToast"\n    invoke-static {v2}, Lcom/bormental/RootCmd;->RunRootCmd(Ljava/lang/String;)I\n\n    iget-object v0, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mPartitionOrder:Landroid/preference/ListPreference;\n    check-cast p2, Ljava/lang/String;\n    invoke-virtual {v0, p2}, Landroid/preference/ListPreference;->findIndexOfValue(Ljava/lang/String;)I\n    move-result v0\n\n    const/4 v1, 0x0\n    if-ne v0, v1, :sdextint\n    const-string v2, "mount -ro remount,rw /system"\n    invoke-static {v2}, Lcom/bormental/RootCmd;->RunRootCmd(Ljava/lang/String;)I\n    const-string v2, "cp /system/etc/extra/sdintext.img /system/etc/extra/boot.img"\n    goto :finish_storage\n\n    :sdextint\n    const/4 v1, 0x1\n    if-ne v0, v1, :intonly\n    const-string v2, "mount -ro remount,rw /system"\n    invoke-static {v2}, Lcom/bormental/RootCmd;->RunRootCmd(Ljava/lang/String;)I\n    const-string v2, "cp /system/etc/extra/sdextint.img /system/etc/extra/boot.img"\n    goto :finish_storage\n\n    :intonly\n    const/4 v1, 0x2\n    if-ne v0, v1, :sdonly\n    const-string v2, "mount -ro remount,rw /system"\n    invoke-static {v2}, Lcom/bormental/RootCmd;->RunRootCmd(Ljava/lang/String;)I\n    const-string v2, "cp /system/etc/extra/sdextint.img /system/etc/extra/boot.img"\n    goto :finish_storage\n\n    :sdonly\n    const/4 v1, 0x3\n    if-ne v0, v1, :end_storage\n    const-string v2, "mount -ro remount,rw /system"\n    invoke-static {v2}, Lcom/bormental/RootCmd;->RunRootCmd(Ljava/lang/String;)I\n    const-string v2, "cp /system/etc/extra/sdonly.img /system/etc/extra/boot.img"\n\n    :finish_storage\n    invoke-static {v2}, Lcom/bormental/RootCmd;->RunRootCmd(Ljava/lang/String;)I\n    const-string v2, "dd if=/system/etc/extra/boot.img of=/dev/bootimg"\n    invoke-static {v2}, Lcom/bormental/RootCmd;->RunRootCmd(Ljava/lang/String;)I\n    invoke-virtual {p0}, Lcom/android/settings/deviceinfo/MiuiMemory;->getContentResolver()Landroid/content/ContentResolver;\n    move-result-object v1\n    const-string v2, "select_primary_storage"\n    invoke-static {v1, v2, v0}, Landroid/provider/Settings$System;->putInt(Landroid/content/ContentResolver;Ljava/lang/String;I)Z\n    iget-object v1, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mPartitionOrder:Landroid/preference/ListPreference;\n    invoke-virtual {v1, v0}, Landroid/preference/ListPreference;->setValueIndex(I)V\n    invoke-virtual {v1}, Landroid/preference/ListPreference;->getEntry()Ljava/lang/CharSequence;\n    move-result-object v0\n    invoke-virtual {v1, v0}, Landroid/preference/ListPreference;->setSummary(Ljava/lang/CharSequence;)V\n    const/4 v0, 0x1\n    return v0\n    :end_storage";
replaceinmethod "%smali%/com/android/settings/deviceinfo/MiuiMemory.smali" ".method public onResume()V" "    :cond_0" "    :cond_0\n\n    iget-object v0, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mPartitionOrder:Landroid/preference/ListPreference;\n\n    if-eqz v0, :cond_10\n\n    invoke-virtual {p0}, Lcom/android/settings/deviceinfo/MiuiMemory;->getContentResolver()Landroid/content/ContentResolver;\n\n    move-result-object v0\n\n    const-string v1, "select_primary_storage"\n\n    const/4 v2, 0x0\n\n    invoke-static {v0, v1, v2}, Landroid/provider/Settings$System;->getInt(Landroid/content/ContentResolver;Ljava/lang/String;I)I\n\n    move-result v0\n\n    iget-object v1, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mPartitionOrder:Landroid/preference/ListPreference;\n\n    invoke-virtual {v1}, Landroid/preference/ListPreference;->getEntries()[Ljava/lang/CharSequence;\n\n    move-result-object v1\n\n    array-length v1, v1\n\n    add-int/lit8 v1, v1, -0x1\n\n    invoke-static {v0, v1}, Ljava/lang/Math;->min(II)I\n\n    move-result v0\n\n    iget-object v1, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mPartitionOrder:Landroid/preference/ListPreference;\n\n    invoke-virtual {v1, v0}, Landroid/preference/ListPreference;->setValueIndex(I)V\n\n    iget-object v0, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mPartitionOrder:Landroid/preference/ListPreference;\n\n    iget-object v1, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mPartitionOrder:Landroid/preference/ListPreference;\n\n    invoke-virtual {v1}, Landroid/preference/ListPreference;->getEntry()Ljava/lang/CharSequence;\n\n    move-result-object v1\n\n    invoke-virtual {v0, v1}, Landroid/preference/ListPreference;->setSummary(Ljava/lang/CharSequence;)V\n\n    :cond_10";
replaceinfile "%res%/xml/device_info_memory.xml" "</PreferenceCategory>\n</PreferenceScreen>" "</PreferenceCategory>\n    <PreferenceCategory>\n        <ListPreference android:entries="@array/primary_storage_entries" android:title="@string/primary_storage_title" android:key="select_primary_storage" android:entryValues="@array/primary_storage_values" />\n    </PreferenceCategory>\n</PreferenceScreen>";
