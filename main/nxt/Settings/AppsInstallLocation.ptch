appfile <Settings.apk>;

# App install location
replaceinfile "%smali%/com/android/settings/deviceinfo/MiuiMemory.smali"    		"instance fields" 										"instance fields\n .field private mInstallLocation:Landroid/preference/ListPreference;";
replaceinmethod "%smali%/com/android/settings/deviceinfo/MiuiMemory.smali" 		".method public onCreate(Landroid/os/Bundle;)V" 						"return-void" 				"const-string v0, "default_install_location"\n    invoke-virtual {p0, v0}, Lcom/android/settings/deviceinfo/MiuiMemory;->findPreference(Ljava/lang/CharSequence;)Landroid/preference/Preference;\n    move-result-object v0\n    check-cast v0, Landroid/preference/ListPreference;\n    iput-object v0, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mInstallLocation:Landroid/preference/ListPreference;\n    iget-object v0, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mInstallLocation:Landroid/preference/ListPreference;\n    invoke-virtual {v0, p0}, Landroid/preference/ListPreference;->setOnPreferenceChangeListener(Landroid/preference/Preference$OnPreferenceChangeListener;)V\n    return-void";
replaceinmethod "%smali%/com/android/settings/deviceinfo/MiuiMemory.smali" 		".method public onPreferenceChange(Landroid/preference/Preference;Ljava/lang/Object;)Z" 	".prologue" 				".prologue\n    iget-object v0, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mInstallLocation:Landroid/preference/ListPreference;\n    if-ne v0, p1, :cond_40\n    if-eqz v0, :cond_40\n    iget-object v0, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mInstallLocation:Landroid/preference/ListPreference;\n    check-cast p2, Ljava/lang/String;\n    invoke-virtual {v0, p2}, Landroid/preference/ListPreference;->findIndexOfValue(Ljava/lang/String;)I\n    move-result v0\n    invoke-virtual {p0}, Lcom/android/settings/deviceinfo/MiuiMemory;->getContentResolver()Landroid/content/ContentResolver;\n    move-result-object v1\n    const-string v2, "default_install_location"\n    invoke-static {v1, v2, v0}, Landroid/provider/Settings$Global;->putInt(Landroid/content/ContentResolver;Ljava/lang/String;I)Z\n    iget-object v1, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mInstallLocation:Landroid/preference/ListPreference;\n    invoke-virtual {v1, v0}, Landroid/preference/ListPreference;->setValueIndex(I)V\n    invoke-virtual {v1}, Landroid/preference/ListPreference;->getEntry()Ljava/lang/CharSequence;\n    move-result-object v0\n    invoke-virtual {v1, v0}, Landroid/preference/ListPreference;->setSummary(Ljava/lang/CharSequence;)V\n    const/4 v0, 0x1 \n    return v0 \n    :cond_40";
replaceinmethod "%smali%/com/android/settings/deviceinfo/MiuiMemory.smali" 		".method public onResume()V" 									"return-void" 				"iget-object v0, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mInstallLocation:Landroid/preference/ListPreference;\n    if-eqz v0, :cond_20\n    invoke-virtual {p0}, Lcom/android/settings/deviceinfo/MiuiMemory;->getContentResolver()Landroid/content/ContentResolver;\n    move-result-object v0\n    const-string v1, "default_install_location"\n    const/4 v2, 0x0\n    invoke-static {v0, v1, v2}, Landroid/provider/Settings$Global;->getInt(Landroid/content/ContentResolver;Ljava/lang/String;I)I\n    move-result v0\n    iget-object v1, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mInstallLocation:Landroid/preference/ListPreference;\n    invoke-virtual {v1}, Landroid/preference/ListPreference;->getEntries()[Ljava/lang/CharSequence;\n    move-result-object v1\n    array-length v1, v1\n    add-int/lit8 v1, v1, -0x1\n    invoke-static {v0, v1}, Ljava/lang/Math;->min(II)I\n    move-result v0\n    iget-object v1, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mInstallLocation:Landroid/preference/ListPreference;\n    invoke-virtual {v1, v0}, Landroid/preference/ListPreference;->setValueIndex(I)V\n    iget-object v0, p0, Lcom/android/settings/deviceinfo/MiuiMemory;->mInstallLocation:Landroid/preference/ListPreference;\n    invoke-virtual {v0}, Landroid/preference/ListPreference;->getEntry()Ljava/lang/CharSequence;\n    move-result-object v1\n    invoke-virtual {v0, v1}, Landroid/preference/ListPreference;->setSummary(Ljava/lang/CharSequence;)V\n :cond_20 \n   return-void";
replaceinfile "%res%/xml/device_info_memory.xml"    					"</PreferenceCategory>\n</PreferenceScreen>" 							"</PreferenceCategory>\n    <PreferenceCategory>\n        <ListPreference android:entries="@array/default_install_location_entries" android:title="@string/app_install_location_title" android:key="default_install_location"  android:entryValues="@array/default_install_location_values" /> \n    </PreferenceCategory>\n</PreferenceScreen>";
# Do not forget to add XML arrays patches: default_install_location_entries, default_install_location_values

appfile <Services.jar>;

# Fix apps nstall lcation
replaceinmethod "%smali%/com/android/server/pm/PackageManagerService$InstallParams.smali" 	".method private installLocationPolicy(Landroid/content/pm/PackageInfoLite;I)I"		".prologue"		".prologue\n    iget-object v0, p0, Lcom/android/server/pm/PackageManagerService$InstallParams;->this$0:Lcom/android/server/pm/PackageManagerService;\n    iget-object v0, v0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;\n    invoke-virtual {v0}, Landroid/content/Context;->getContentResolver()Landroid/content/ContentResolver;\n    move-result-object v0\n    const-string v1, "default_install_location"\n    const/4 v2, 0x0\n    invoke-static {v0, v1, v2}, Landroid/provider/Settings$Global;->getInt(Landroid/content/ContentResolver;Ljava/lang/String;I)I\n    move-result v2\n    const/4 v4, 0x1\n    if-ne v4, v2, :cond_20\n    return v4\n    :cond_20";
